name: Deploy Docs

on:
  push:
    branches:
      - main
      - "*.x"

permissions:
  contents: write

concurrency:
  group: docs-pages-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve target version
        id: version
        run: node scripts/resolve-version.mjs --github-output "$GITHUB_OUTPUT"

      - name: Prepare gh-pages workspace
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git ls-remote --exit-code --heads origin gh-pages; then
            git clone --depth 1 --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" .gh-pages
          else
            mkdir -p .gh-pages
            cd .gh-pages
            git init
            git checkout --orphan gh-pages
            git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          fi

      - name: Build versions catalog
        id: catalog
        run: |
          mkdir -p .gh-pages/docs
          VERSION_CSV=$(node scripts/build-version-catalog.mjs .gh-pages/docs/versions.json "${{ steps.version.outputs.version_slug }}")
          echo "version_csv=${VERSION_CSV}" >> "$GITHUB_OUTPUT"

      - name: Build Docusaurus site
        env:
          DOCS_VERSION: ${{ steps.version.outputs.version_slug }}
          DOCS_VERSIONS: ${{ steps.catalog.outputs.version_csv }}
          DOCS_BASE_URL: /docs/${{ steps.version.outputs.version_slug }}/
          SITE_URL: https://${{ github.repository_owner }}.github.io
        run: npm run build

      - name: Publish version folder
        run: |
          mkdir -p ".gh-pages/docs/${{ steps.version.outputs.version_slug }}"
          rsync -a --delete build/ ".gh-pages/docs/${{ steps.version.outputs.version_slug }}/"

      - name: Create index redirects
        run: |
          cat > .gh-pages/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=/docs/next/">
          <title>Kairos Docs</title>
          <a href="/docs/next/">Go to documentation</a>
          HTML

          cat > .gh-pages/docs/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=/docs/next/">
          <title>Kairos Docs</title>
          <a href="/docs/next/">Go to documentation</a>
          HTML

      - name: Commit and push gh-pages
        working-directory: .gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs index.html
          if git diff --cached --quiet; then
            echo "No changes to publish"
            exit 0
          fi
          git commit -m "chore: publish docs ${{ steps.version.outputs.version_slug }}"
          git push origin HEAD:gh-pages
